---
import { useStoryblokApi } from '@storyblok/astro'
import StoryblokComponent from '@storyblok/astro/StoryblokComponent.astro'
import Layout from '../shell/Layout.astro'

// Let Astro know where to look to build your routes
export async function getStaticPaths() {
    const
        storyblokApi = useStoryblokApi(),
        { data } = await storyblokApi.get('cdn/links', {
            version: import.meta.env.DEV ? 'draft' : 'published'
        })

    let links = data.links
    links = Object.values(links).filter((link: any) => !link.slug.includes('settings'))

    return links.map((link: any) => {
        return {
            params: {
                slug: link.slug === 'home' ? undefined : link.slug,
            }
        }
    })
}

// Pull slug from the routes and corresponding content/blocks from Storyblok
const
    { slug } = Astro.params,
    storyblokApi = useStoryblokApi(),
    { data } = await storyblokApi.get(`cdn/stories/${slug === undefined ? 'home' : slug}`, {
        version: import.meta.env.DEV ? 'draft' : 'published'
    }),
    page = data.story,
    content = page.content,
    meta = content.meta[0]
---
<Layout
    pageTitle={ meta.title }
    pageDescription={ meta.description }
    pageThumbnail={ meta.image.filename }>
    <StoryblokComponent blok={ content }/>
</Layout>